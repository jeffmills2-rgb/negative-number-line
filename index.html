<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Number line – Missing value</title>
  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --ink: #111827;
      --muted: #6b7280;
      --line: #1f2937;
      --accent: #2563eb;
      --ok: #16a34a;
      --bad:#dc2626;

      --label:#374151;
      --label-soft:#4b5563;
      --box:#0f172a;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 18px;

      --border:#e5e7eb;
      --panel:#ffffff;
      --warn:#f59e0b;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--ink);
    }
    .wrap{
      max-width: 1100px;
      margin: 22px auto 40px;
      padding: 0 16px;
    }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 14px;
      position: relative;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    h1{
      font-size: 18px;
      margin:0;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 800;
      cursor:pointer;
      background: #f3f4f6;
      color: #111827;
      transition: transform .04s ease, filter .15s ease;
      user-select:none;
    }
    button:active{ transform: scale(.98); }
    button.primary{
      background: var(--accent);
      color: white;
    }
    button.danger{
      background:#fee2e2;
      color:#991b1b;
    }
    button.icon{
      padding: 10px 12px;
      min-width: 44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight: 900;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:#f3f4f6;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color:#111827;
      font-weight: 800;
    }
    .pill.warn{
      background:#fffbeb;
      color:#92400e;
      border:1px solid rgba(245,158,11,.25);
    }

    /* ---------- Tools dropdown (robust) ---------- */
    .toolsWrap{
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    .toolsBtn{
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      border: 1px solid var(--border);
      background:#f3f4f6;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .toolsBtn:hover{ filter: brightness(0.98); }
    .toolsBtn .caret{
      display:inline-block;
      transition: transform .15s ease;
      font-weight: 1000;
    }
    .toolsBtn[aria-expanded="true"] .caret{
      transform: rotate(180deg);
    }

    .toolsMenu{
      position: absolute;
      top: calc(100% + 10px);
      right: 0;
      width: 290px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.12);
      padding: 10px;
      display: none;
      z-index: 50;
    }
    .toolsMenu.open{ display:block; }
    .toolsItem{
      width: 100%;
      text-align: left;
      border: none;
      background: transparent;
      padding: 12px 12px;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      color: #111827;
    }
    .toolsItem:hover{
      background:#f3f4f6;
    }
    .toolsHint{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      padding: 8px 12px 4px;
    }

    /* Teacher settings (collapsible) */
    .teacherbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 6px;
      margin-bottom: 10px;
    }
    .teacherleft{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .settingsBtn{
      background:#f3f4f6;
      color:#111827;
      border:1px solid #e5e7eb;
      border-radius:999px;
    }
    .chev{
      display:inline-block;
      transition: transform .15s ease;
      font-weight: 900;
    }
    .chev.open{ transform: rotate(180deg); }

    .settings{
      margin-top: 10px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      display:none;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .settings.open{ display:grid; }
    @media (max-width: 780px){
      .settings{ grid-template-columns: 1fr; }
    }
    .panel{
      background:#f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
    }
    .panel h3{
      margin:0 0 8px;
      font-size: 13px;
      color:#111827;
      letter-spacing:.2px;
    }

    .row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .stat{
      font-size: 13px;
      color: var(--muted);
      font-weight: 800;
    }
    .bigstat{
      font-size: 14px;
      font-weight: 900;
      color:#111827;
    }

    /* Inputs */
    .field{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 8px;
      flex-wrap:wrap;
    }
    .field label{
      font-weight: 900;
      color:#111827;
      font-size: 13px;
    }
    .inp{
      display:flex;
      align-items:center;
      gap:8px;
    }
    input[type="text"]{
      width: 140px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      outline: none;
      font-weight: 900;
      color:#111827;
      background:#fff;
    }
    input[type="text"]:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }
    .err{
      display:none;
      margin-top: 8px;
      font-size: 12px;
      font-weight: 900;
      color: var(--bad);
    }
    .err.show{ display:block; }

    /* Toggle */
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 10px;
      user-select:none;
      cursor:pointer;
    }
    .switch{
      width: 44px;
      height: 26px;
      border-radius: 999px;
      background:#e5e7eb;
      position:relative;
      border:1px solid #d1d5db;
      flex: 0 0 auto;
      transition: background .15s ease;
    }
    .knob{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background:#fff;
      position:absolute;
      left:2px;
      top:1px;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      transition: transform .15s ease;
    }
    .toggle.on .switch{
      background: rgba(37,99,235,.95);
      border-color: rgba(37,99,235,.25);
    }
    .toggle.on .knob{
      transform: translateX(18px);
    }
    .toggleText{
      font-weight: 900;
      font-size: 13px;
      color:#111827;
      line-height: 1.15;
    }
    .toggleHint{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-top: 2px;
    }

    /* Stage */
    .stage{
      margin-top: 14px;
      padding: 12px 12px 18px;
      border-radius: 16px;
      background: linear-gradient(180deg,#ffffff, #f9fafb);
      border: 1px solid #e5e7eb;
      overflow:hidden;
      position: relative;
      min-height: 420px;
    }
    .svgwrap{
      width:100%;
      height: 360px;
    }

    /* Bottom actions inside the stage */
    .stageActions{
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      pointer-events: none;
    }
    .stageActions button{ pointer-events: auto; }
    .stageActions button{
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 950;
      box-shadow: 0 12px 24px rgba(0,0,0,.10);
    }

    /* Teacher-only shortcuts hint inside settings */
    .shortcuts{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      background:#111827;
      color:white;
      padding: 2px 6px;
      border-radius: 7px;
      font-weight: 900;
    }

    /* Solid dots (NO wobble) */
    .tick-dot{
      transition: opacity .12s ease;
    }
    .tick-dot:hover{
      opacity: 1;
    }

    /* Animations */
    @keyframes boxPulse {
      0%,100% { filter: drop-shadow(0 0 0 rgba(37,99,235,0)); }
      50%     { filter: drop-shadow(0 0 10px rgba(37,99,235,.35)); }
    }
    .box-pulse { animation: boxPulse 1.4s ease-in-out infinite; }

    @keyframes wipeIn {
      from { opacity: 0; transform: translateX(-10px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    .wipe-in { animation: wipeIn .22s ease-out both; }

    @keyframes pop {
      0%   { transform: scale(0.92); opacity: 0; }
      60%  { transform: scale(1.06); opacity: 1; }
      100% { transform: scale(1); }
    }
    .pop {
      animation: pop .22s ease-out both;
      transform-origin: center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div><h1>Number line – Missing value</h1></div>

        <div class="btnrow">
          <div class="toolsWrap" id="toolsWrap">
            <button id="toolsBtn" class="toolsBtn" aria-expanded="false" aria-haspopup="true">
              Tools <span class="caret">▼</span>
            </button>
            <div id="toolsMenu" class="toolsMenu" role="menu" aria-label="Tools menu">
              <div class="toolsHint">Open in a new tab</div>
              <button class="toolsItem" id="toolWorksheet" role="menuitem">Worksheet creator</button>
              <button class="toolsItem" id="toolQuiz" role="menuitem">Student Online Quiz</button>
            </div>
          </div>

          <button id="resetBtn" class="danger" title="Reset settings + history">Reset</button>
        </div>
      </div>

      <div class="teacherbar">
        <div class="teacherleft">
          <button id="settingsBtn" class="settingsBtn icon" aria-expanded="false">
            <span style="font-weight:900;">Teacher settings</span>
            <span id="chev" class="chev">▼</span>
          </button>

          <span class="pill" id="summaryPill">step 1 · midpoint 0</span>
          <span class="pill" id="negPill">Negatives: off</span>
          <span class="pill" id="modePill">Hidden</span>
          <span class="pill warn" id="pendingPill" style="display:none;">Pending changes (apply on Next)</span>
        </div>
      </div>

      <div id="settings" class="settings">
        <div class="panel">
          <h3>Step size</h3>
          <div class="field">
            <label for="stepInput">Enter step size</label>
            <div class="inp">
              <input id="stepInput" type="text" inputmode="decimal" autocomplete="off" />
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="stat">Max:</div>
            <div class="bigstat">1000</div>
            <div class="stat">· 1 decimal place</div>
          </div>
          <div class="err" id="stepErr">Please enter a number greater than 0 (up to 1000), max 1 decimal place.</div>

          <div class="shortcuts">
            Shortcuts:
            <span class="kbd">Space</span> next
            <span class="kbd">R</span> reveal/hide
            <div class="shortcuts" style="margin-top:6px;">
              Click tick dots to reveal extra labels (optional).
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>Midpoint (middle tick value)</h3>
          <div class="field">
            <label for="midInput">Enter midpoint</label>
            <div class="inp">
              <input id="midInput" type="text" inputmode="decimal" autocomplete="off" />
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="stat">Range:</div>
            <div class="bigstat">-10000 to 10000</div>
            <div class="stat">· 1 decimal place</div>
          </div>
          <div class="err" id="midErr">Please enter a number from -10000 to 10000, max 1 decimal place.</div>

          <div class="toggle" id="negToggle" title="Bias questions toward negative-side missing values when negatives exist on the line">
            <div class="switch"><div class="knob"></div></div>
            <div>
              <div class="toggleText">Prefer negatives</div>
              <div class="toggleHint">Only applies if the line includes negatives.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="stage">
        <svg id="svg" class="svgwrap" viewBox="0 0 1000 360" role="img" aria-label="number line"></svg>

        <div class="stageActions">
          <button id="revealBtn" class="ghost" title="R">Reveal (R)</button>
          <button id="nextBtn" class="primary" title="Space">Next Question (Space)</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // Limits + formatting rules
  const STEP_MAX = 1000;
  const MID_MIN = -10000;
  const MID_MAX =  10000;

  // Current applied settings
  let step = 1.0;
  let midpoint = 0.0;
  let preferNegatives = false;

  // Pending settings (apply on Next)
  let pendingStep = step;
  let pendingMid  = midpoint;
  let pendingDirty = false;

  let revealed = false;
  let settingsOpen = false;

  let q = null;
  const last5 = [];

  let refs = null; // { labelsByIndex, labelsG, labelY, xFn, dots, ticks }

  const svg = document.getElementById('svg');

  const nextBtn = document.getElementById('nextBtn');
  const revealBtn = document.getElementById('revealBtn');
  const resetBtn = document.getElementById('resetBtn');

  const summaryPill = document.getElementById('summaryPill');
  const modePill = document.getElementById('modePill');
  const negPill = document.getElementById('negPill');
  const pendingPill = document.getElementById('pendingPill');

  const settingsBtn = document.getElementById('settingsBtn');
  const settings = document.getElementById('settings');
  const chev = document.getElementById('chev');

  // Inputs
  const stepInput = document.getElementById('stepInput');
  const midInput  = document.getElementById('midInput');
  const stepErr   = document.getElementById('stepErr');
  const midErr    = document.getElementById('midErr');

  // Prefer negatives toggle
  const negToggle = document.getElementById('negToggle');

  // Tools dropdown elements
  const toolsWrap = document.getElementById('toolsWrap');
  const toolsBtn = document.getElementById('toolsBtn');
  const toolsMenu = document.getElementById('toolsMenu');
  const toolWorksheet = document.getElementById('toolWorksheet');
  const toolQuiz = document.getElementById('toolQuiz');

  const EPS = 1e-9;

  const randInt = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
  const choice = (arr) => arr[randInt(0, arr.length-1)];
  const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));

  function round1(x){ return Math.round(x * 10) / 10; }

  // Display formatting: drop trailing .0
  function fmt(x){
    const r = round1(x);
    if (Math.abs(r - Math.round(r)) < EPS) return String(Math.round(r));
    return r.toFixed(1);
  }

  // Parse + validate a number with max 1 decimal place
  function parseOneDecimal(str){
    const s = (str ?? "").trim();
    if (!s) return { ok:false };
    // allow leading +/-, digits, optional .digits
    if (!/^[+-]?\d+(\.\d+)?$/.test(s)) return { ok:false };
    const n = Number(s);
    if (!Number.isFinite(n)) return { ok:false };
    // enforce <= 1 decimal place
    const oneDec = round1(n);
    if (Math.abs(n - oneDec) > 1e-6) return { ok:false };
    return { ok:true, value: oneDec };
  }

  function setPendingDirty(on){
    pendingDirty = on;
    pendingPill.style.display = pendingDirty ? "inline-flex" : "none";
  }

  function updatePills(){
    summaryPill.textContent = `step ${fmt(step)} · midpoint ${fmt(midpoint)}`;
    negPill.textContent = `Negatives: ${preferNegatives ? "prefer" : "off"}`;
    modePill.textContent = revealed ? "Revealed" : "Hidden";
    revealBtn.textContent = revealed ? "Hide (R)" : "Reveal (R)";
    negToggle.classList.toggle("on", preferNegatives);
  }

  function setSettingsOpen(open){
    settingsOpen = open;
    settings.classList.toggle('open', settingsOpen);
    chev.classList.toggle('open', settingsOpen);
    settingsBtn.setAttribute('aria-expanded', String(settingsOpen));
  }

  // ---------- Tools dropdown: robust open/close ----------
  function setToolsOpen(open){
    toolsMenu.classList.toggle('open', open);
    toolsBtn.setAttribute('aria-expanded', String(open));
  }
  function isToolsOpen(){
    return toolsMenu.classList.contains('open');
  }
  toolsBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    setToolsOpen(!isToolsOpen());
  });

  // Close when clicking outside
  document.addEventListener('click', (e) => {
    if (!isToolsOpen()) return;
    if (toolsWrap.contains(e.target)) return;
    setToolsOpen(false);
  });

  // Close on Esc
  document.addEventListener('keydown', (e) => {
    if (e.key === "Escape" && isToolsOpen()){
      setToolsOpen(false);
    }
  });

  function openInNewTab(file){
    window.open(file, "_blank", "noopener,noreferrer");
  }

  toolWorksheet.addEventListener('click', () => {
    setToolsOpen(false);
    openInNewTab("integerworksheet.html");
  });

  toolQuiz.addEventListener('click', () => {
    setToolsOpen(false);
    openInNewTab("studentquiz.html");
  });

  // "Nice anchor" scoring (float-safe)
  function isNiceAnchor(v){
    const av = Math.abs(v);

    // Prefer integers strongly
    const isInt = Math.abs(v - Math.round(v)) < EPS;

    if (!isInt) {
      // If not integer, still treat .0 (handled above) and allow 0.5-style as mildly "nice"
      // but less nice than integers.
      const frac = Math.abs(v - Math.floor(v));
      const isHalf = Math.abs(frac - 0.5) < EPS;
      if (isHalf) return av < 10; // only "nice" at small magnitudes
      return false;
    }

    // Integer rules (same spirit as your original)
    const iv = Math.round(v);
    if (av >= 100) return iv % 100 === 0 || iv % 10 === 0;
    if (av >= 10)  return iv % 10 === 0;
    return true;
  }

  function signatureFor(question){
    const answer = question.values[question.targetIndex];
    return { answer, targetIndex: question.targetIndex, step, midpoint };
  }
  function matchesAnyRecent(sig){
    for (const s of last5){
      if (Math.abs(s.answer - sig.answer) < EPS) return true;
      if (s.targetIndex === sig.targetIndex) return true;
      if (Math.abs(s.step - sig.step) < EPS && Math.abs(s.midpoint - sig.midpoint) < EPS && s.targetIndex === sig.targetIndex) return true;
    }
    return false;
  }

  function pickAnchors(values, targetIndex){
    const pairs = [];
    for (let i=0; i<10; i++){
      if (i === targetIndex) continue;
      if (i+1 === targetIndex) continue;
      const v1 = values[i], v2 = values[i+1];
      let score = 0;
      if (isNiceAnchor(v1)) score += 2;
      if (isNiceAnchor(v2)) score += 2;
      pairs.push({i, score});
    }
    pairs.sort((a,b) => b.score - a.score);
    const bestScore = pairs.length ? pairs[0].score : 0;
    const topPairs = pairs.filter(p => p.score === bestScore);
    const pair = topPairs.length ? choice(topPairs) : {i: randInt(0,9)};

    const idxA = pair.i;
    const idxB = pair.i + 1;

    const farCandidates = [];
    for (let j=0; j<11; j++){
      if (j === targetIndex) continue;
      if (j === idxA || j === idxB) continue;
      const v = values[j];
      let score = 0;
      if (isNiceAnchor(v)) score += 3;
      score += Math.abs(j - idxA) * 0.25;
      farCandidates.push({j, score});
    }
    farCandidates.sort((a,b) => b.score - a.score);
    const bestFar = farCandidates.length ? farCandidates[0].score : 0;
    const topFar = farCandidates.filter(c => c.score === bestFar);
    const far = topFar.length ? choice(topFar).j : randInt(0,10);

    return new Set([idxA, idxB, far]);
  }

  function buildValuesFromMidpoint(){
    const vals = [];
    for (let i=0;i<11;i++){
      const v = round1(midpoint + (i - 5) * step);
      vals.push(v);
    }
    return vals;
  }

  function chooseTargetIndex(values){
    // Weighted like before, but optionally bias toward negative values
    const anyNeg = values.some(v => v < 0);

    // base weights
    const weightedAll = [];
    for (let i=0;i<11;i++){
      let w = 1;
      if (i===0 || i===10) w = 0.8;
      if (i===5) w = 0.9;
      for (let k=0;k<Math.round(w*10);k++) weightedAll.push(i);
    }

    if (preferNegatives && anyNeg){
      const negIdx = values.map((v,i)=> (v < 0 ? i : null)).filter(v => v !== null);
      const weightedNeg = [];
      for (const i of negIdx){
        let w = 1.15; // slight boost
        if (i===0 || i===10) w = 0.95;
        if (i===5) w = 1.0;
        for (let k=0;k<Math.round(w*10);k++) weightedNeg.push(i);
      }

      // 70%: pick from negative side, else normal
      if (weightedNeg.length && Math.random() < 0.70){
        return choice(weightedNeg);
      }
    }

    return choice(weightedAll);
  }

  function generateQuestion(){
    // With fixed midpoint + step, only target/anchors vary.
    for (let attempt=0; attempt<120; attempt++){
      const values = buildValuesFromMidpoint();
      const targetIndex = chooseTargetIndex(values);

      const anchors = pickAnchors(values, targetIndex);
      if (anchors.has(targetIndex)) continue;

      const question = {
        values,
        targetIndex,
        anchors,
        teacherRevealed: new Set()
      };

      const sig = signatureFor(question);
      if (matchesAnyRecent(sig)) continue;

      last5.push(sig);
      while (last5.length > 5) last5.shift();

      return question;
    }

    // Fallback
    const values = buildValuesFromMidpoint();
    return {
      values,
      targetIndex: 4,
      anchors: new Set([0,1,10]),
      teacherRevealed: new Set()
    };
  }

  function clearSVG(){
    while (svg.firstChild) svg.removeChild(svg.firstChild);
    refs = null;
  }
  function el(name, attrs={}, children=[]){
    const n = document.createElementNS("http://www.w3.org/2000/svg", name);
    for (const [k,v] of Object.entries(attrs)) n.setAttribute(k, String(v));
    for (const c of children) n.appendChild(c);
    return n;
  }
  function textNode(str, attrs={}){
    const t = el('text', attrs);
    t.textContent = str;
    return t;
  }

  function buildHiddenScene(question){
    clearSVG();

    const left=90, right=910;
    const yLine=160;
    const tickTop=yLine-14, tickBot=yLine+14;
    const n=11;
    const x = (i) => left + (right-left)* (i/(n-1));
    const labelY = 248;

    svg.appendChild(textNode("What is the missing value?", {
      x: 500, y: 56, "text-anchor":"middle",
      "font-size":"30", "font-weight":"950", fill:"#111827"
    }));
    svg.appendChild(textNode("Write it. Show me. Reveal.", {
      x: 500, y: 86, "text-anchor":"middle",
      "font-size":"14", "font-weight":"850", fill:"#9ca3af"
    }));

    svg.appendChild(el('line', {
      x1:left, y1:yLine, x2:right, y2:yLine,
      stroke: "#1f2937", "stroke-width":"4", "stroke-linecap":"round"
    }));

    const ticksG = el('g', {});
    const dotsG  = el('g', {});
    const labelsG= el('g', {});
    const boxG   = el('g', { id: "mysteryBox" });

    const labelsByIndex = new Map();
    const ticks = [];
    const dots = [];

    function highlightTeacher(idx){
      const tick = ticks[idx];
      const dot  = dots[idx];
      if (tick) tick.setAttribute("stroke-width", "5");
      if (dot){
        dot.setAttribute("opacity", "1");
        dot.setAttribute("fill", "#2563eb");
      }
    }

    function ensureLabel(idx, animate){
      if (labelsByIndex.has(idx)) return;
      if (idx === question.targetIndex) return;

      const allowed = question.anchors.has(idx) || question.teacherRevealed.has(idx);
      if (!allowed) return;

      const t = textNode(fmt(question.values[idx]), {
        x: x(idx),
        y: labelY,
        "text-anchor":"middle",
        "font-size":"24",
        "font-weight":"900",
        fill: "var(--label)"
      });
      if (animate) t.classList.add("wipe-in");
      labelsG.appendChild(t);
      labelsByIndex.set(idx, t);

      if (question.teacherRevealed.has(idx)) highlightTeacher(idx);
    }

    function handleTickClick(idx){
      if (revealed) return;
      if (idx === question.targetIndex) return;
      question.teacherRevealed.add(idx);
      ensureLabel(idx, true);
      highlightTeacher(idx);
    }

    for (let i=0;i<n;i++){
      const xi = x(i);

      const tick = el('line', {
        x1:xi, y1:tickTop, x2:xi, y2:tickBot,
        stroke:"#1f2937", "stroke-width":"4",
        "stroke-linecap":"round"
      });
      tick.style.cursor = "pointer";
      tick.addEventListener('click', () => handleTickClick(i));
      ticksG.appendChild(tick);
      ticks.push(tick);

      const dot = el('circle', {
        cx: xi, cy: yLine,
        r: 7,
        fill: "#111827",
        opacity: 0.75
      });
      dot.classList.add("tick-dot");
      dot.style.cursor = "pointer";
      dot.addEventListener('click', () => handleTickClick(i));
      dotsG.appendChild(dot);
      dots.push(dot);
    }

    for (const idx of question.anchors){
      if (idx !== question.targetIndex) ensureLabel(idx, false);
    }

    const tx = x(question.targetIndex);
    const boxW=64, boxH=44;
    const boxX = tx - boxW/2;
    const boxY = labelY - 34;

    const rect = el('rect', {
      x: boxX, y: boxY,
      width: boxW, height: boxH,
      rx: 12, ry: 12,
      fill: "var(--box)"
    });
    rect.classList.add("box-pulse");

    const qmark = textNode("?", {
      x: tx, y: boxY + 31,
      "text-anchor":"middle",
      "font-size":"28",
      "font-weight":"950",
      fill:"#ffffff"
    });

    boxG.appendChild(rect);
    boxG.appendChild(qmark);

    svg.appendChild(ticksG);
    svg.appendChild(dotsG);
    svg.appendChild(labelsG);
    svg.appendChild(boxG);

    refs = { labelsByIndex, labelsG, labelY, xFn: x, dots, ticks };
  }

  function revealAllLabels(question){
    if (!refs) return;

    svg.querySelector('#mysteryBox')?.remove();

    for (let i=0;i<11;i++){
      if (refs.labelsByIndex.has(i)) continue;

      const t = textNode(fmt(question.values[i]), {
        x: refs.xFn(i),
        y: refs.labelY,
        "text-anchor":"middle",
        "font-weight":"900",
        fill: "var(--label-soft)",
        "font-size":"24"
      });

      const isAnswer = (i === question.targetIndex);
      if (isAnswer){
        t.setAttribute("fill", "var(--ok)");
        t.setAttribute("font-size", "34");
        t.setAttribute("font-weight", "950");
        t.classList.add("pop");
      } else {
        t.classList.add("wipe-in");
        t.style.animationDelay = (i * 0.04) + "s";
      }

      refs.labelsG.appendChild(t);
      refs.labelsByIndex.set(i, t);
    }
  }

  function hideToPrompt(question){
    if (!refs) return;

    question.teacherRevealed.clear();

    for (let i=0;i<11;i++){
      const lab = refs.labelsByIndex.get(i);
      if (!lab) continue;

      const keep = question.anchors.has(i);
      if (!keep){
        lab.remove();
        refs.labelsByIndex.delete(i);
      }
    }

    for (let i=0;i<11;i++){
      if (refs.ticks[i]) refs.ticks[i].setAttribute("stroke-width", "4");
      if (refs.dots[i]){
        refs.dots[i].setAttribute("opacity", "0.75");
        refs.dots[i].setAttribute("fill", "#111827");
      }
    }

    if (!svg.querySelector('#mysteryBox')){
      const tx = refs.xFn(question.targetIndex);
      const boxW=64, boxH=44;
      const boxX = tx - boxW/2;
      const boxY = refs.labelY - 34;

      const boxG = el('g', { id: "mysteryBox" });

      const rect = el('rect', {
        x: boxX, y: boxY,
        width: boxW, height: boxH,
        rx: 12, ry: 12,
        fill: "var(--box)"
      });
      rect.classList.add("box-pulse");

      const qmark = textNode("?", {
        x: tx, y: boxY + 31,
        "text-anchor":"middle",
        "font-size":"28",
        "font-weight":"950",
        fill:"#ffffff"
      });

      boxG.appendChild(rect);
      boxG.appendChild(qmark);
      svg.appendChild(boxG);
    }
  }

  function render(){
    updatePills();

    if (!q){
      q = generateQuestion();
      revealed = false;
      buildHiddenScene(q);
      return;
    }

    if (!refs){
      buildHiddenScene(q);
      return;
    }

    if (revealed){
      revealAllLabels(q);
    } else {
      hideToPrompt(q);
    }
  }

  // ---------- Validation + pending settings ----------
  function validateStepField(s){
    const parsed = parseOneDecimal(s);
    if (!parsed.ok) return { ok:false };
    if (parsed.value <= 0) return { ok:false };
    if (parsed.value > STEP_MAX) return { ok:false };
    return parsed;
  }
  function validateMidField(s){
    const parsed = parseOneDecimal(s);
    if (!parsed.ok) return { ok:false };
    if (parsed.value < MID_MIN || parsed.value > MID_MAX) return { ok:false };
    return parsed;
  }

  function syncFieldsFromApplied(){
    stepInput.value = fmt(step);
    midInput.value  = fmt(midpoint);
    stepErr.classList.remove("show");
    midErr.classList.remove("show");
    setPendingDirty(false);
    pendingStep = step;
    pendingMid  = midpoint;
  }

  function handleStepInput(){
    const v = validateStepField(stepInput.value);
    if (!v.ok){
      stepErr.classList.add("show");
      return false;
    }
    stepErr.classList.remove("show");
    pendingStep = v.value;
    setPendingDirty(Math.abs(pendingStep - step) > EPS || Math.abs(pendingMid - midpoint) > EPS);
    return true;
  }

  function handleMidInput(){
    const v = validateMidField(midInput.value);
    if (!v.ok){
      midErr.classList.add("show");
      return false;
    }
    midErr.classList.remove("show");
    pendingMid = v.value;
    setPendingDirty(Math.abs(pendingStep - step) > EPS || Math.abs(pendingMid - midpoint) > EPS);
    return true;
  }

  function applyPendingIfValid(){
    const okStep = handleStepInput();
    const okMid  = handleMidInput();
    if (!okStep || !okMid) return false;

    // apply
    step = pendingStep;
    midpoint = pendingMid;
    setPendingDirty(false);
    return true;
  }

  // Apply inputs only on Next
  function nextQuestion(){
    // Try apply pending; if invalid, don't advance
    if (!applyPendingIfValid()) return;

    revealed = false;
    q = generateQuestion();
    buildHiddenScene(q);
    render();
  }

  // Input listeners: validate and mark pending, but do not regenerate
  stepInput.addEventListener("input", () => { handleStepInput(); });
  midInput.addEventListener("input",  () => { handleMidInput(); });

  // Toggle
  negToggle.addEventListener("click", () => {
    preferNegatives = !preferNegatives;
    updatePills();
  });

  // Bottom buttons
  nextBtn.addEventListener('click', () => nextQuestion());

  revealBtn.addEventListener('click', () => {
    revealed = !revealed;
    render();
  });

  resetBtn.addEventListener('click', () => {
    step = 1.0;
    midpoint = 0.0;
    preferNegatives = false;

    revealed = false;
    last5.length = 0;
    q = null;

    syncFieldsFromApplied();
    clearSVG();
    render();
  });

  settingsBtn.addEventListener('click', () => {
    setSettingsOpen(!settingsOpen);
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.code === "Space"){
      e.preventDefault();
      nextQuestion();
    }
    if (e.key.toLowerCase() === "r"){
      e.preventDefault();
      revealed = !revealed;
      render();
    }
  });

  // Initial state: auto load midpoint=0 step=1
  setSettingsOpen(false);
  syncFieldsFromApplied();

  q = generateQuestion();
  buildHiddenScene(q);
  render();
})();
</script>
</body>
</html>
